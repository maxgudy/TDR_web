<!DOCTYPE html>
<html>
<head>
    <title>TDR - Automatitzacions amb IA</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:ital,opsz,wght@0,17..18,400..700;1,17..18,400..700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <!-- Sidebar Navigation -->
    <aside class="sidebar">
        <a href="#" class="element nav-element active" data-page="gpt-profes">
            <svg focusable="false" width="20" height="20" viewBox="0 0 24 24" class="icon1">
                <path d="M12 3L1 9l4 2.18v6L12 21l7-3.82v-6l2-1.09V17h2V9L12 3zm6.82 6L12 12.72 5.18 9 12 5.28 18.82 9zM17 15.99l-5 2.73-5-2.73v-3.72L12 15l5-2.73v3.72z"></path>
            </svg>
            <span class="GPTPROFES">Agent Professors</span>
        </a>
        <a href="#" class="element nav-element" data-page="faq-email">
            <svg focusable="false" width="20" height="20" viewBox="0 0 24 24" class="icon1" fill="currentColor">
                <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 14h-8v-2h8v2zm0-4h-8v-2h8v2zm-3-5V3.5L18.5 9H13z"></path>
            </svg>
            <span>Agent Famílies i Alumnes</span>
        </a>
        <a href="#" class="element nav-element" data-page="dades-estudiants">
            <svg focusable="false" width="20" height="20" viewBox="0 0 24 24" class="icon1" fill="currentColor">
                <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"></path>
            </svg>
            <span>Agent Directius</span>
        </a>
    </aside>

    <main>
        <!-- Header del chat -->
        <div class="chat-header" id="chatHeader">
            <div class="header-content">
                <div class="header-info">
                    <h2 class="header-title">Agent Professors</h2>
                    <p class="header-subtitle">Max Gudayol · Automatitzacions amb IA</p>
                </div>
                <button class="theme-toggle" id="themeToggle" title="Canviar tema">
                    <svg class="sun-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 18C8.68629 18 6 15.3137 6 12C6 8.68629 8.68629 6 12 6C15.3137 6 18 8.68629 18 12C18 15.3137 15.3137 18 12 18ZM12 16C14.2091 16 16 14.2091 16 12C16 9.79086 14.2091 8 12 8C9.79086 8 8 9.79086 8 12C8 14.2091 9.79086 16 12 16ZM11 1H13V4H11V1ZM11 20H13V23H11V20ZM3.51472 4.92893L4.92893 3.51472L7.05025 5.63604L5.63604 7.05025L3.51472 4.92893ZM16.9497 18.364L18.364 16.9497L20.4853 19.0711L19.0711 20.4853L16.9497 18.364ZM19.0711 3.51472L20.4853 4.92893L18.364 7.05025L16.9497 5.63604L19.0711 3.51472ZM5.63604 16.9497L7.05025 18.364L4.92893 20.4853L3.51472 19.0711L5.63604 16.9497ZM23 11V13H20V11H23ZM4 11V13H1V11H4Z"></path>
                    </svg>
                    <svg class="moon-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="display: none;">
                        <path d="M10 7C10 10.866 13.134 14 17 14C18.9584 14 20.729 13.1957 21.9995 11.8995C22 11.933 22 11.9665 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C12.0335 2 12.067 2 12.1005 2.00049C10.8043 3.27098 10 5.04157 10 7ZM4 12C4 16.4183 7.58172 20 12 20C15.0583 20 17.7158 18.2839 19.062 15.7621C18.3945 15.9187 17.7035 16 17 16C12.0294 16 8 11.9706 8 7C8 6.29648 8.08133 5.60547 8.2379 4.938C5.71611 6.28423 4 8.9417 4 12Z"></path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Pàgina: Agent Professors -->
        <div id="page-gpt-profes" class="page active">
            <div class="mainqest" id="mainqest-gpt">
                <p class="pregunta" id="pregunta-gpt">En què estàs treballant?</p>
                
                <div class="chat-container" id="chatContainer-gpt" style="display: none;">
                    <div class="messages" id="messages-gpt"></div>
                    <div class="typing-indicator" id="typingIndicator-gpt" style="display: none;">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
                
                <div class="questionform" id="questionform-gpt">
                    <div class="plus-sign-icon" id="plusIcon-gpt">
                        <svg width="25" height="25" viewBox="0 0 25 25" fill="rgba(74, 74, 74, 0.9)" xmlns="http://www.w3.org/2000/svg" class="iconplus">
                            <path d="M9.33496 16.5V10.665H3.5C3.13273 10.665 2.83496 10.3673 2.83496 10C2.83496 9.63273 3.13273 9.33496 3.5 9.33496H9.33496V3.5C9.33496 3.13273 9.63273 2.83496 10 2.83496C10.3673 2.83496 10.665 3.13273 10.665 3.5V9.33496H16.5L16.6338 9.34863C16.9369 9.41057 17.165 9.67857 17.165 10C17.165 10.3214 16.9369 10.5894 16.6338 10.6514L16.5 10.665H10.665V16.5C10.665 16.8673 10.3673 17.165 10 17.165C9.63273 17.165 9.33496 16.8673 9.33496 16.5Z"></path>
                        </svg>
                    </div>
                    <input type="text" id="inputquest-gpt" placeholder="Pregunta el que vulguis" class="inputquest">
                </div>
            </div>

            <section class="professor-app" id="professor-app">
                <div id="formFeedback-gpt" class="form-feedback"></div>
                <div class="professor-tabs">
                    <button type="button" class="professorat-tab active" data-tab="classes">Classes i Registres</button>
                    <button type="button" class="professorat-tab" data-tab="students">Alumnes i Notes</button>
                </div>

                <div id="panel-classes" class="professorat-panel active">
                    <div class="panel-header">
                        <div>
                            <p class="panel-label">Classes</p>
                            <h3>Gestió de Classes</h3>
                        </div>
                        <div class="panel-actions">
                            <button type="button" class="form-submit-btn" id="createClassBtn">+ Crear classe</button>
                            <button type="button" class="form-cancel-btn" id="deleteClassBtn">Eliminar classe</button>
                        </div>
                    </div>
                    <div class="panel-body">
                        <div class="field-group">
                            <label for="classSelector">Selecciona una classe</label>
                            <select id="classSelector">
                                <option value="">Selecciona una classe</option>
                            </select>
                        </div>
                        <div class="registre-tabs">
                            <button type="button" class="registre-subtab active" data-subtab="excursions">Excursions</button>
                            <button type="button" class="registre-subtab" data-subtab="homeworks">Deures</button>
                        </div>
                        <div class="registre-subpanel active" id="subpanel-excursions">
                            <div class="subpanel-toolbar">
                                <span>Excursions registrades</span>
                                <button type="button" class="form-submit-btn" id="createExcursionBtn">+ Crear Excursió</button>
                            </div>
                            <form id="form-excursion" class="clean-form hidden-panel">
                                <div class="form-grid">
                                    <div class="form-field span-2">
                                        <label for="excursionTitle">Títol</label>
                                        <input id="excursionTitle" name="title" type="text" placeholder="Ex: Visita al museu">
                                    </div>
                                    <div class="form-field">
                                        <label for="excursionDate">Data</label>
                                        <input id="excursionDate" name="date" type="date">
                                    </div>
                                    <div class="form-field">
                                        <label for="excursionPrice">Preu</label>
                                        <input id="excursionPrice" name="price" type="number" step="0.01" placeholder="Opcional">
                                    </div>
                                </div>
                                <div class="form-actions">
                                    <button type="submit" class="form-submit-btn">Guardar Excursió</button>
                                    <button type="button" class="form-cancel-btn" id="cancelExcursionForm">Cancel·lar</button>
                                </div>
                            </form>
                            <div id="excursionsList" class="list-card">Cap excursió creada.</div>
                            <div id="excursionDetail" class="detail-card hidden-panel">
                                <div class="detail-header">
                                    <div class="detail-heading">
                                        <p class="panel-label">Gestió d'assistència</p>
                                        <h4 id="excursionDetailTitle"></h4>
                                        <p id="excursionDetailMeta" class="detail-meta"></p>
                                    </div>
                                    <div class="detail-actions">
                                        <button type="button" class="detail-action-btn" id="excursionEditBtn">Editar</button>
                                        <button type="button" class="detail-action-btn" id="excursionDeleteBtn">Eliminar</button>
                                        <button type="button" class="form-cancel-btn" onclick="closeExcursionDetail()">Tancar</button>
                                    </div>
                                </div>
                                <div class="detail-table">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Alumne</th>
                                                <th>Ve</th>
                                                <th>Pagat</th>
                                                <th>Comentari</th>
                                            </tr>
                                        </thead>
                                        <tbody id="excursionStatusTableBody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="registre-subpanel" id="subpanel-homeworks">
                            <div class="subpanel-toolbar">
                                <span>Deures</span>
                                <button type="button" class="form-submit-btn" id="createHomeworkBtn">+ Crear Deure</button>
                            </div>
                            <form id="form-homework" class="clean-form hidden-panel">
                                <div class="form-grid">
                                    <div class="form-field span-2">
                                        <label for="homeworkTitle">Títol</label>
                                        <input id="homeworkTitle" name="title" type="text" placeholder="Ex: Exercicis 12">
                                    </div>
                                    <div class="form-field">
                                        <label for="homeworkSubject">Assignatura</label>
                                        <input id="homeworkSubject" name="subject" type="text" placeholder="Opcional">
                                    </div>
                                    <div class="form-field">
                                        <label for="homeworkDate">Data entrega</label>
                                        <input id="homeworkDate" name="dueDate" type="date">
                                    </div>
                                    <div class="form-field span-2">
                                        <label for="homeworkDescription">Descripció</label>
                                        <textarea id="homeworkDescription" name="description" rows="2" placeholder="Comentaris"></textarea>
                                    </div>
                                </div>
                                <div class="form-actions">
                                    <button type="submit" class="form-submit-btn">Guardar Deure</button>
                                    <button type="button" class="form-cancel-btn" id="cancelHomeworkForm">Cancel·lar</button>
                                </div>
                            </form>
                            <div id="homeworksList" class="list-card">Cap deure creat.</div>
                            <div id="homeworkDetail" class="detail-card hidden-panel">
                                <div class="detail-header">
                                    <h4 id="homeworkDetailTitle"></h4>
                                    <button type="button" class="form-cancel-btn" onclick="closeHomeworkDetail()">Tancar</button>
                                </div>
                                <div class="detail-table">
                                    <table>
                                        <tbody id="homeworkStatusTableBody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="panel-students" class="professorat-panel">
                    <div class="panel-header">
                        <div>
                            <p class="panel-label">Alumnes</p>
                            <h3>Gestió d'Alumnes i Notes</h3>
                        </div>
                        <div class="global-search">
                            <input id="globalStudentSearch" type="text" placeholder="Cerca global d'alumnes" oninput="handleGlobalStudentSearch(event)">
                            <div id="globalSearchResults" class="search-results"></div>
                        </div>
                    </div>
                    <div class="panel-body">
                        <div class="students-panel-card">
                        <div class="student-toolbar">
                            <div class="student-filter">
                                <label for="classSelectorStudents">Classe</label>
                                <select id="classSelectorStudents">
                                    <option value="">Selecciona una classe</option>
                                </select>
                            </div>
                            <button type="button" class="form-submit-btn" id="addStudentBtn">+ Afegir Alumne</button>
                        </div>
                            <form id="form-student" class="card-form hidden-panel">
                                <div class="form-grid">
                                    <label>
                                        <span>Nom *</span>
                                        <input type="text" name="firstName" placeholder="Nom">
                                    </label>
                                    <label>
                                        <span>Cognoms *</span>
                                        <input type="text" name="lastName" placeholder="Cognoms">
                                    </label>
                                    <label>
                                        <span>Email</span>
                                        <input type="email" name="email" placeholder="Opcional">
                                    </label>
                                </div>
                                <input type="hidden" id="student-class" name="classId">
                                <div class="form-actions">
                                    <button type="submit" class="form-submit-btn">Guardar Alumne</button>
                                    <button type="button" class="form-cancel-btn" id="cancelStudentForm">Cancel·lar</button>
                                </div>
                            </form>
                            <div class="students-table-container">
                                <div class="table-search">
                                    <input id="studentSearch" type="text" placeholder="Cercar per nom o cognoms...">
                                </div>
                                <table class="students-table">
                                    <thead>
                                        <tr>
                                            <th>Nom</th>
                                            <th>Cognoms</th>
                                            <th>Email</th>
                                            <th>Classe</th>
                                            <th>Mitjana</th>
                                            <th>Actiu</th>
                                            <th>Accions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="studentsTableBody">
                                        <tr class="empty-row">
                                            <td colspan="7">Selecciona una classe per veure els alumnes</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Secció de Notes integrada -->
                            <div class="notes-section-wrapper">
                                <div id="gradesSection" class="grades-section hidden-panel">
                                    <div class="grade-summary">
                                        <div>
                                          <p id="selectedStudentName">Nom alumne</p>
                                          <p id="selectedStudentClass">Classe del alumne</p>
                                      </div>
                                      <div class="grade-average">
                                          <span>Mitjana:</span>
                                          <strong id="studentAverage">-</strong>
                                      </div>
                                  </div>
                                  <form id="form-note" class="grade-form">
                                      <div class="grade-row">
                                          <label for="grade-value">Qualificació *</label>
                                          <input id="grade-value" name="value" type="text" placeholder="0-10">
                                      </div>
                                      <div class="grade-row">
                                          <label for="grade-type">Tipus d'avaluació</label>
                                          <select id="grade-type" name="type">
                                              <option value="">Selecciona...</option>
                                              <option value="exam">Examen (80%)</option>
                                              <option value="homework">Deure (10%)</option>
                                              <option value="activity">Activitat (10%)</option>
                                          </select>
                                      </div>
                                      <div class="grade-row">
                                          <label for="grade-date">Data</label>
                                          <input id="grade-date" name="date" type="date">
                                      </div>
                                      <div class="form-actions">
                                          <button type="submit" class="form-submit-btn">Guardar Nota</button>
                                          <button type="button" class="form-cancel-btn" id="cancelGradeEditBtn">Cancelar</button>
                                      </div>
                                  </form>
                                  <div id="notesList" class="notes-list">No hi ha notes seleccionades.</div>
                                  <div id="notesHistory" class="notes-history hidden-panel"></div>
                              </div>
                          </div>
                      </div>
                    </div>
                </div>

            </section>

        </div>

        <!-- Pàgina: Agent Famílies i Alumnes -->
        <div id="page-faq-email" class="page">
            <div class="mainqest" id="mainqest-faq">
                <p class="pregunta" id="pregunta-faq">En què estàs treballant?</p>
                
                <div class="chat-container" id="chatContainer-faq" style="display: none;">
                    <div class="messages" id="messages-faq"></div>
                    <div class="typing-indicator" id="typingIndicator-faq" style="display: none;">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
                
                <div class="questionform" id="questionform-faq">
                    <div class="plus-sign-icon" id="plusIcon-faq">
                        <svg width="25" height="25" viewBox="0 0 25 25" fill="rgba(74, 74, 74, 0.9)" xmlns="http://www.w3.org/2000/svg" class="iconplus">
                            <path d="M9.33496 16.5V10.665H3.5C3.13273 10.665 2.83496 10.3673 2.83496 10C2.83496 9.63273 3.13273 9.33496 3.5 9.33496H9.33496V3.5C9.33496 3.13273 9.63273 2.83496 10 2.83496C10.3673 2.83496 10.665 3.13273 10.665 3.5V9.33496H16.5L16.6338 9.34863C16.9369 9.41057 17.165 9.67857 17.165 10C17.165 10.3214 16.9369 10.5894 16.6338 10.6514L16.5 10.665H10.665V16.5C10.665 16.8673 10.3673 17.165 10 17.165C9.63273 17.165 9.33496 16.8673 9.33496 16.5Z"></path>
                        </svg>
                    </div>
                    <input type="text" id="inputquest-faq" placeholder="Pregunta el que vulguis" class="inputquest">
                </div>
            </div>
        </div>

        <!-- Pàgina: Agent Directius -->
        <div id="page-dades-estudiants" class="page">
            <div class="mainqest" id="mainqest-dades">
                <p class="pregunta" id="pregunta-dades">En què estàs treballant?</p>
                
                <div class="chat-container" id="chatContainer-dades" style="display: none;">
                    <div class="messages" id="messages-dades"></div>
                    <div class="typing-indicator" id="typingIndicator-dades" style="display: none;">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
                
                <div class="questionform" id="questionform-dades">
                    <div class="plus-sign-icon" id="plusIcon-dades">
                        <svg width="25" height="25" viewBox="0 0 25 25" fill="rgba(74, 74, 74, 0.9)" xmlns="http://www.w3.org/2000/svg" class="iconplus">
                            <path d="M9.33496 16.5V10.665H3.5C3.13273 10.665 2.83496 10.3673 2.83496 10C2.83496 9.63273 3.13273 9.33496 3.5 9.33496H9.33496V3.5C9.33496 3.13273 9.63273 2.83496 10 2.83496C10.3673 2.83496 10.665 3.13273 10.665 3.5V9.33496H16.5L16.6338 9.34863C16.9369 9.41057 17.165 9.67857 17.165 10C17.165 10.3214 16.9369 10.5894 16.6338 10.6514L16.5 10.665H10.665V16.5C10.665 16.8673 10.3673 17.165 10 17.165C9.63273 17.165 9.33496 16.8673 9.33496 16.5Z"></path>
                        </svg>
                    </div>
                    <input type="text" id="inputquest-dades" placeholder="Pregunta el que vulguis" class="inputquest">
                </div>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/professorat.js"></script>
    <script src="js/student-forms.js"></script>
    <script src="js/agents.js"></script>
    <script src="js/dashboard.js"></script>
    <script src="js/main.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const tabs = document.querySelectorAll('.professorat-tab');
            const panels = document.querySelectorAll('.professorat-panel');
            tabs.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Guardar posició de scroll
                    const currentScrollY = window.scrollY || window.pageYOffset;
                    
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    const target = tab.getAttribute('data-tab');
                    panels.forEach(panel => {
                        panel.classList.toggle('active', panel.id === `panel-${target}`);
                    });
                    
                    // Restaurar posició de scroll
                    window.scrollTo(0, currentScrollY);
                    requestAnimationFrame(() => {
                        window.scrollTo(0, currentScrollY);
                    });
                });
            });

            const subtabs = document.querySelectorAll('.registre-subtab');
            const subpanels = document.querySelectorAll('.registre-subpanel');
            subtabs.forEach(subtab => {
                subtab.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Guardar posició de scroll
                    const currentScrollY = window.scrollY || window.pageYOffset;
                    
                    subtabs.forEach(s => s.classList.remove('active'));
                    subtab.classList.add('active');
                    const target = subtab.getAttribute('data-subtab');
                    subpanels.forEach(panel => {
                        panel.classList.toggle('active', panel.id === `subpanel-${target}`);
                    });
                    
                    // Restaurar posició de scroll
                    window.scrollTo(0, currentScrollY);
                    requestAnimationFrame(() => {
                        window.scrollTo(0, currentScrollY);
                    });
                });
            });

            // Els event listeners dels formularis i botons estan gestionats per professorat.js
            console.log('[Index] DOMContentLoaded - esperant que professorat.js s\'inicialitzi');
        });
    </script>
    
    <!-- Script específic per a cada pàgina de chat -->
    <script>
        // Funcionalitat de chat per a tots els agents
        function initChatPage(pageId) {
            // Mapejar IDs per compatibilitat
            const idMap = {
                'gpt-profes': 'gpt',
                'faq-email': 'faq',
                'dades-estudiants': 'dades'
            };
            const shortId = idMap[pageId] || pageId;
            
            const inputQuest = document.getElementById(`inputquest-${shortId}`);
            const messagesContainer = document.getElementById(`messages-${shortId}`);
            const typingIndicator = document.getElementById(`typingIndicator-${shortId}`);
            const chatContainer = document.getElementById(`chatContainer-${shortId}`);
            const pregunta = document.getElementById(`pregunta-${shortId}`);
            const mainqest = document.getElementById(`mainqest-${shortId}`);
            const questionform = document.getElementById(`questionform-${shortId}`);
            const plusIcon = document.getElementById(`plusIcon-${shortId}`);
            
            if (!inputQuest || !messagesContainer) return;
            
            let isFirstMessage = true;
            
            function initializeChat() {
                if (pregunta) pregunta.style.display = 'none';
                if (chatContainer) chatContainer.style.display = 'flex';
                if (mainqest) {
                    mainqest.style.justifyContent = 'flex-start';
                    mainqest.style.paddingTop = '90px';
                    mainqest.classList.add('chat-mode');
                }
                if (questionform) {
                    questionform.style.position = 'fixed';
                    questionform.style.bottom = '20px';
                    questionform.style.left = 'calc(240px + 50%)';
                    questionform.style.transform = 'translateX(-50%)';
                    questionform.style.width = '900px';
                    questionform.style.maxWidth = 'calc(100% - 280px)';
                }
            }
            
            function addMessage(text, isUser) {
                const messageDiv = document.createElement('div');
                messageDiv.className = isUser ? 'message user-message' : 'message bot-message';
                
                if (!isUser && typeof marked !== 'undefined') {
                    messageDiv.innerHTML = marked.parse(text);
                } else {
                    messageDiv.innerHTML = text;
                }
                
                messagesContainer.appendChild(messageDiv);
                scrollToBottom();
            }
            
            function scrollToBottom() {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
            
            function showTyping() {
                if (typingIndicator) typingIndicator.style.display = 'flex';
                scrollToBottom();
            }
            
            function hideTyping() {
                if (typingIndicator) typingIndicator.style.display = 'none';
            }
            
            async function sendMessage() {
                const message = inputQuest.value.trim();
                
                if (message === '') return;
                
                if (isFirstMessage) {
                    isFirstMessage = false;
                    initializeChat();
                }
                
                addMessage(message, true);
                inputQuest.value = '';
                showTyping();
                
                const result = await sendMessageToAgent(message, pageId);
                hideTyping();
                
                if (result.success) {
                    addMessage(result.response, false);
                } else {
                    addMessage('Error en enviar el missatge. Si us plau, intenta-ho de nou.', false);
                }
            }
            
            inputQuest.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            if (plusIcon) {
                plusIcon.addEventListener('click', sendMessage);
            }
        }
        
        // Inicialitzar chats quan es canvia de pàgina
        window.addEventListener('pageChanged', (e) => {
            const pageId = e.detail.pageId;
            
            // Inicialitzar chat específic de la pàgina
            if (pageId === 'gpt-profes' || pageId === 'faq-email' || pageId === 'dades-estudiants') {
                setTimeout(() => initChatPage(pageId), 100);
            }
        });
        
        // Inicialitzar chats a la càrrega inicial
        document.addEventListener('DOMContentLoaded', () => {
            const hash = window.location.hash.slice(1) || 'gpt-profes';
            if (hash === 'gpt-profes' || hash === 'faq-email' || hash === 'dades-estudiants') {
                setTimeout(() => initChatPage(hash), 200);
            }
        });
    </script>
    <div class="modal-overlay" id="deleteClassModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Eliminar Classe</h3>
                <button class="modal-close" onclick="closeDeleteClassModal()">×</button>
            </div>
            <div class="modal-form">
                <p>Eliminaràs la classe <strong id="deleteClassName">?</strong> i totes les dades relacionades.</p>
                <p>Aquesta acció no es pot recuperar.</p>
                <div class="modal-actions">
                    <button type="button" class="form-submit-btn" id="deleteClassConfirmBtn">Eliminar classe</button>
                    <button type="button" class="form-cancel-btn" onclick="closeDeleteClassModal()">Cancel·lar</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="createClassModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Crear Classe</h3>
                <button class="modal-close" onclick="closeCreateClassModal()">×</button>
            </div>
            <form id="createClassForm" class="modal-form">
                <label for="newClassName">Nom de la classe</label>
                <input id="newClassName" name="name" type="text" placeholder="Ex: 4t ESO A" required>
                <div class="modal-actions">
                    <button type="submit" class="form-submit-btn">Crear classe</button>
                    <button type="button" class="form-cancel-btn" onclick="closeCreateClassModal()">Cancel·lar</button>
                </div>
            </form>
        </div>
    </div>
</body>
</html>
